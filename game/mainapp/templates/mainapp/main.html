{% extends "base.html" %}
{%load static%}
{% block script %}
<script>
    let dic_onoff = -1; // dic panel을 관리하기위한 전역변수
    let achievement_onoff = -1; // achievement panel을 관리하기위한 전역변수
      function preload(){
        // resource load
        this.load.image('dic', "{% static '/resource/ui/main/dic.png'%}")
        this.load.image('analysis', "{% static '/resource/ui/main/analysis2.png'%}")
        this.load.image('store', "{% static '/resource/ui/main/store2.png'%}")
        this.load.image('skills', "{% static '/resource/ui/main/skills2.png'%}")
        this.load.image('start', "{% static '/resource/ui/main/start2.png'%}")
        this.load.image('achievement', "{% static '/resource/ui/main/achievement.png'%}")
        this.load.image('namespace', "{% static '/resource/ui/main/namespace.png'%}")
        this.load.image('character', "{% static '/resource/ui/main/status.png'%}")
        this.load.image('background', "{% static '/resource/ui/background.jpg'%}")
        this.load.image('panel', "{% static '/resource/ui/background.jpg'%}")
        this.load.image('sound_on', "{% static '/resource/ui/main/musicOn.png'%}")
        this.load.image('sound_off', "{% static '/resource/ui/main/musicOff.png'%}")
        this.load.audio('title_music', "{% static '/resource/bgm/title_music.mp3'%}")
        this.load.image('profile_image', "http://localhost:8000/media/profile/profile_image.png")

        //this.load.image('setting', "{% static '/resource/ui/gear.png'%}")
        //this.load.image('toggle', "{% static '/resource/ui/box.png'%}")
        //this.load.image('checkmark', "{% static '/resource/ui/checkmark.png'%}")
      }
      
      function create(){ 
        //this.scale.displaySize.setAspectRatio( width/height )
        //this.scale.refresh()

        //add resource
        this.bgm = this.sound.play("title_music", {loop:true})
        this.add.image(150,300,'background')
        this.add.image(35,35,'profile_image').setInteractive({cursor:'pointer'})
        let circle = this.add.circle(35,35,25)
        this.add.image(150,130,'character').setScale(0.3).setInteractive({cursor:'pointer'})
        this.add.image(60,220,'dic').setScale(0.3).setInteractive({cursor:'pointer'})
        let achievement = this.add.image(60,270,'achievement').setScale(0.3).setInteractive({cursor:'pointer'})
        this.add.image(240,530,'start').setInteractive({cursor:'pointer'})
        this.add.image(255,430,'store').setInteractive({cursor:'pointer'})
        this.add.image(170,455,'skills').setInteractive({cursor:'pointer'})
        this.add.image(140,540,'analysis').setInteractive({cursor:'pointer'})
        this.add.image(150,30,'namespace').setScale(0.3)
        let sound_off = this.add.image(270,30,'sound_off').setInteractive({cursor:'pointer'})
        let sound_on = this.add.image(270,30,'sound_on').setInteractive({cursor:'pointer'})
        let panel1 = this.add.image(-150,300,'panel').setScale(0.7).setInteractive({cursor:'pointer'})
        let panel2 = this.add.image(-150,300,'panel').setScale(0.7).setInteractive({cursor:'pointer'})

        //let toggle = this.add.image(-150, 150, 'toggle').setScale(0.3).setInteractive({cursor:'pointer'})
        //let setting = this.add.image(270,30,'setting').setInteractive({cursor:'pointer'})
        //let checkmark = this.add.image(-150,150,'checkmark').setScale(0.5)
        
        circle.setStrokeStyle(2,0x868686)
        panel1.alpha = 0.7
        panel2.alpha = 0.7
        
        // 새로고침, 페이지 이동, 재접속 등 환경이 변경되었을때 bgm의 상태를 유지하기 위하여 localstorage에 상태를 저장
        if(localStorage.getItem('bgm')==null){ 
          console.log(localStorage.getItem('bgm'))
          this.bgm = this.sound.play("title_music", {loop:true})
          sound_off.visible = false
          sound_on.visible = true
          localStorage.setItem("bgm", 'true')
          console.log(localStorage.getItem('bgm'))
        }
        else if(localStorage.getItem('bgm')=='true'){ 
          this.bgm = this.sound.play("title_music", {loop:true})
          sound_off.visible = false
          sound_on.visible = true
          console.log(localStorage.getItem('bgm'))
        }
        else if(localStorage.getItem('bgm')=='false'){
          game.sound.mute = true
          sound_off.visible = true
          sound_on.visible = false
        }

        // username을 DB에서 fetch를 통해 불러온다.
        this.username = this.add.text(
          125,
          20,
          "",
          {
            color:'black',
            font:'550 20px Poppins',
          }
        )

        fetch('http://localhost:8000/core/api/user')
          .then(res=>res.json())
          .then((data)=>{
            console.log(data)
            let name = String(data.username)
            this.username.setText(name)
            console.log(name)
           })
        
        // object에 마우스를 올려놨을때 작동하는 코드
        this.input.on('gameobjectover', function(pointer, gameObject){
          let link = gameObject.texture.key

          if(String(link) =='profile_image'){
            console.log(link)
          }
          else if(String(link) =='panel'){
            console.log(link)
          }
          else{
            gameObject.setTint(0x50bcdf)
          }
        })

        // object에서 마우스가 벗어났을때 작동하는 코드
        this.input.on('gameobjectout', function(pointer, gameObject){
          gameObject.clearTint()
        })
        
        // object를 클릭하였을때 작동하는 코드
        this.input.on('gameobjectdown', function(pointer, gameObject){
          let link = gameObject.texture.key
          console.log(link)
          /*
          if(String(link) =='toggle'){
            toggle.clearTint()
            var active = checkmark.visible
            active = !active
            game.sound.mute = !active
            checkmark.visible = active

            if(localStorage.getItem('bgm')=='true'){
              localStorage.setItem("bgm", 'false')
            }
            else if(localStorage.getItem('bgm')=='false'){
              localStorage.setItem("bgm", 'true')
            }           
          }
          */
          if(String(link)=='sound_on'){
            game.sound.mute = true
            sound_on.visible = false
            sound_off.visible = true
            localStorage.setItem("bgm", 'false')
          }
          else if(String(link)=='sound_off'){
            game.sound.mute = false
            sound_on.visible = true
            sound_off.visible = false
            localStorage.setItem("bgm", 'true')
          }
          else if(String(link) =='dic'){
            if(achievement_onoff==1){
              panel2.setX(-150)
              achievement_onoff=-1
              panel1.setX(150)
              dic_onoff=1
            }
            else if(dic_onoff==1){
              panel1.setX(-150)
              dic_onoff=-1
            }
            else{
              panel1.setX(150)
              dic_onoff=1
            }
          }
          else if(String(link) =='achievement'){
            if(dic_onoff==1){
              panel1.setX(-150)
              dic_onoff=-1
              panel2.setX(150)
              achievement_onoff=1
            }
            else if(achievement_onoff==1){
              panel2.setX(-150)
              achievement_onoff=-1
            }
            else{
              panel2.setX(150)
              achievement_onoff=1
            }
          }
          else if(String(link) =='profile_image'){

          }
          else{
            link = 'http://localhost:8000/mainapp/' + String(link)
            location.replace(link)
          }
        })

        this.input.setTopOnly(true)
      }

      function update(){
      }
      
      let config = {
        type: Phaser.CANVAS,
        width: 300,
        height: 600,
        scene: {
          preload: preload,
          create: create,
          update:update,
        },
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
        },
        pixelArt: false,
        render:{
          antialias: true
        },
        /*
        plugins: {
          global: [
            {
              key: "PhaserDebugGameScalePlugin",
              plugin: PhaserDebugGameScalePlugin,
              start: true
            }
          ]
        },
        */
      }
      let game =  new Phaser.Game(config)
</script>
{% endblock script %}
